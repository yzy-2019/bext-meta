{"type":"javascript","source":"import { runAt, runOnce, base64 } from '@bext/util';\nrunOnce(() => {\n    if (!window.mbrowser) {\n        window.mbrowser = {\n            isMonkeyScript: (c) => {\n                let monk = false, cfm;\n                [\n                    'GM_info',\n                    'GM_deleteValue',\n                    'GM_getValue',\n                    'GM_listValues',\n                    'GM_setValue',\n                    'GM_getResourceURL',\n                    'GM_notification',\n                    'GM_openInTab',\n                    'GM_registerMenuCommand',\n                    'GM_setClipboard',\n                    'GM_xmlhttpRequest',\n                    'GM_addStyle',\n                    'GM_addElement',\n                    'GM_addValueChangeListener',\n                    'GM_removeValueChangeListener',\n                    'GM_log',\n                    'GM_getResourceText',\n                    'GM_unregisterMenuCommand',\n                    'GM_download',\n                    'GM_getTab',\n                    'GM_saveTab',\n                    'GM_getTabs',\n                    'GM_batch_download',\n                ].forEach(m => {\n                    if (c.indexOf(m) >= 0) monk = true;\n                });\n                if (monk) {\n                    cfm = confirm('你要安装的脚本可能\\n\\\n          使用了油猴特有的接口。\\n\\\n          由于 Via 不支持这些接口，\\n\\\n          这个脚本可能不会正常执行。\\n\\n\\\n              确定继续安装吗？');\n                    return (!cfm);\n                } else return false;\n            },\n            openUrlOnNewTab: (u, n) => window.open(u),\n            openUrl: (u, n, r) => location.assign(u),\n            showFloatMessageBox: (o, s) => {\n                let fl = document.createElement(\"div\"),\n                    fb = document.createElement(\"div\"),\n                    fp = document.createElement(\"p\");\n                fl.style.cssText = `position:absolute;top:${window.scrollY}px;left:${window.scrollX}px;width:${window.innerWidth}px;height:${window.innerHeight}px;background:transparent;z-index:999999`;\n                fb.style.cssText = `margin:0 auto;padding:0.5em;width:${window.innerWidth / 2}px;min-height:${window.innerWidth / 2}px;top:50%;left:50%;position:fixed;display:table;background:rgba(0,0,0,0.5);border-radius:2px;transform: translateX(-50%) translateY(-50%);z-index:999999`;\n                fp.style.cssText = `font-size:30px;color:white;display:table-cell;vertical-align:middle;overflow-wrap:anywhere;z-index:999999`;\n                fp.innerText = s;\n                fl.ontouchstart = e => document.body.removeChild(e.currentTarget);\n                fb.appendChild(fp);\n                fl.appendChild(fb);\n                document.body.appendChild(fl);\n            },\n            copyToClipboard: (s) => {\n                let ha = document.createElement(\"textarea\");\n                ha.style.cssText = \"position:absolute;top:-100%\";\n                ha.setAttribute(\"readonly\", \"\");\n                ha.value = s;\n                document.body.appendChild(ha);\n                ha.select();\n                document.execCommand(\"copy\");\n                document.body.removeChild(ha);\n                via.toast('拷贝至了剪贴板');\n            },\n            showToast: s => { via.toast(s) },\n            addAdBlockRule: (r, a, b, t) => {\n                let rule;\n                if (t === 0 && r.include('##')) {\n                    rule = r.split('##');\n                    via.record(a ? a : rule[0], rule[1]);\n                } else if (t === 0) {\n                    via.record(a ? a : '*', r);\n                } else if (t === 3) {\n                    rule = r.split('->')[0].split('##');\n                    via.record(a ? a : '*', rule[1]);\n                } else {\n                    via.toast('不支持');\n                }\n            },\n            getUserScriptListByJson: () => \"[]\",\n            fetchScript: function (id) {\n                fetch('https://srvcn.xbext.com/mobile/visits_resource?resource_id=' + id).then(r => r.json()).then(d => {\n                    let monk = false, cfm;\n                    if (d.extra.slice(0, 3) === 'ep.') {\n                        cfm = confirm('你要安装的脚本是\\n\\\nX 浏览器的菜单触发脚本。\\n\\\n由于 Via 不支持添加菜单按钮和\\n\\\n长按触发脚本。\\n\\\n因此在安装以后会直接加载执行。\\n\\\n这可能不是你所期望的效果。\\n\\n\\\n    确定继续安装吗？');\n                        if (!cfm) return;\n                    }\n                    if (this.isMonkeyScript(d.content)) return;\n                    via.addon(base64(JSON.stringify({\n                        id: parseInt(d.id) + 990000,\n                        name: d.title,\n                        author: d.nickname,\n                        url: (d.extra.slice(0, 2) === 'ep') ? '*' : d.extra,\n                        code: base64(d.content)\n                    })));\n                });\n            },\n            addNewScript: function (o) {\n                let xo = JSON.stringify(o),\n                    vid = rid => {\n                        let f = [7, 9, 10, 6, 3, 7, 5, 4, 10, 5, 8, 4, 2, 8, 1, 9], id = 0;\n                        for (let i = 0; i < rid.length; ++i) {\n                            id += rid.charCodeAt(i) * f[i];\n                        }\n                        return id;\n                    };\n                if (isMonkeyScript(xo.content)) return;\n                via.addon(base64(JSON.stringify({\n                    id: vid(xo.resource_id.slice(16)) + 980000,\n                    name: xo.title,\n                    author: xo.nick_name,\n                    url: '*',\n                    code: xo.content\n                })))\n            },\n            scriptInstalled: id => false,\n            getToken: () => \"ffffffffffffffffffffffffffffffff\",\n            getVersionCode: () => 400\n        }\n    }\n    runAt(500, function () {\n        if (location.host === \"srvcn.xbext.com\" &&\n            document.getElementById('check-browser-note')) {\n            document.querySelectorAll('.my-cell').forEach(c => {\n                c.querySelector('.icon-xiazai').addEventListener('click', mbrowser.fetchScript.bind(mbrowser, c.id.slice(1)));\n            });\n        }\n    })\n})","version":"1","name":"X 浏览器接口模拟 for Via","tags":["工具脚本"],"synopsis":"模拟 X 浏览器接口，以便 Via 安装和使用用于 X 浏览器的脚本。","detail":"<p><strong>仅适用于 Via 浏览器</strong></p><p><br></p><p>这个脚本模拟 X 浏览器的接口，以便 Via 可以安装并使用 X 浏览器的脚本。</p><p><br></p><p>当前支持模拟的接口有 :</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.openUrlOnNewTab\n</pre><p>在新窗口打开指定网址</p><p>使用 window.open()，忽略未知数字参数。</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.openUrl\n</pre><p>打开指定网址</p><p>使用 location.assign()，忽略未知数字参数。</p><p>由于 Via 无法通过脚本实现临时返回不重载，</p><p>忽略返回不重载参数。</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.showFloatMessageBox\n</pre><p>弹出悬浮框</p><p>使用创建元素的方法模拟悬浮框。</p><p>第一个参数意义不明，只好忽略。</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.copyToClipboard\n</pre><p>复制指定文字</p><p>使用建立隐藏文本框自动复制实现。</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.showToast\n</pre><p>弹出 Toast</p><p>直接调用 via.toast() 。</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.addAdBlockRule\n</pre><p>添加广告标记规则</p><p>参数: (规则,域名,地址,类型)</p><p>类型为 0 ，规则是一般的 ABP 规则，支持。</p><p class=\"ql-indent-1\">裁切成域名和规则，然后调用 via.record() 添加规则。</p><p>类型为 1 ，规则格式未知，不支持。</p><p>类型为 2 ，规则为 stringify 后的对象，不支持。</p><p>类型为 3 ，规则为 X 浏览器扩展的 ABP 规则，支持。</p><p class=\"ql-indent-1\">这个脚本会去掉扩展部分，然后按照类型 0 处理。</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.getUserScriptListByJson\n</pre><p>上报用户已安装的脚本列表</p><p>由于 Via 无法存储 X 浏览器脚本 ID 的 UUID 格式，</p><p>因此无法正确上报，返回空数组。</p><p><strong>导致按钮永远是 '安装'，</strong></p><p><strong>但已安装的脚本点击 '安装' 会被卸载。</strong></p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.fetchScript\n</pre><p>安装共享页面脚本</p><p>这里使用了 X 浏览器共享页面的非公开数据接口。</p><p><strong>如若某天改了接口或加了验证。</strong></p><p><strong>那么此安装功能也就不再可用了。</strong></p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.addNewScript\n</pre><p>给外部网页提供的安装脚本的接口</p><p>这里用了不可靠的方法转换 ID ，</p><p>无法保证不会有重复 ID 。</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.scriptInstalled\n</pre><p>查询脚本是否安装</p><p>由于上述原因，总是返回 false。</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.getToken\n</pre><p>获取用户 ID</p><p>返回假 ID \"ffffffffffffffffffffffffffffffff\"</p><p><br></p><pre spellcheck=\"false\" class=\"ql-syntax\">mbrowser.getVersionCode\n</pre><p>获取 X 浏览器编译版本号</p><p>返回 400</p><p><br></p><h3><strong>注意事项：</strong></h3><p><br></p><ol><li><strong>由于各种原因，不保证安装的脚本一定可用</strong>。</li><li>由于 X 浏览器接口太多了 (300+)，不可能实现所有接口，<strong>因此肯定会有脚本有兼容问题</strong>。</li><li>X 浏览器新版本已经支持了大部分油猴接口，但 Via 并不支持。<strong>安装此类脚本时将会提示你是否继续</strong>。</li><li>X 浏览器支持菜单和按钮触发脚本，但 Via 只能立即执行。<strong>安装此类脚本时将会提示你是否继续</strong>。</li><li>Via 和 X 的夜间模式是不同的，<strong>所以依赖夜间模式的脚本不会生效</strong>。</li><li>不知是共享页面判断问题，还是 Via 脚本加载问题。在共享页面点击分类和翻页时大概率会识别失效。此时可点击脚本的 安装 按钮，弹出下载提示点 取消，然后脚本会继续安装。</li><li>此脚本不支持低于 WebView 47 的系统内核。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li></ol><p><br></p><p>这个脚本使用了 Bext 的函数库，</p><p>如需二次发布 ( 分享，搬运 等等 ) ，</p><p>需要在显著位置包含如下 MIT 许可文本:</p><pre spellcheck=\"false\" class=\"ql-syntax\">MIT License\nCopyright (c) 2022 ikkz\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n</pre><p><br></p>"}